#####################################################################
# 	Runout switches definitions
#####################################################################
[filament_switch_sensor RUNOUT_T0]
pause_on_runout: False
switch_pin: PC2
runout_gcode:
     _FILAMENT_RUNOUT  ; Call the macro created to handle runout behavior
insert_gcode:
     _LOAD_FILAMENT_PRINTER_CHECK  ; Call the macro created to load filament dynamically
event_delay: 0.5
pause_delay: 0.5


[filament_switch_sensor RUNOUT_T1]
pause_on_runout: False
switch_pin: PA0
runout_gcode:
      _FILAMENT_RUNOUT  ; Call the macro created to handle runout behavior
insert_gcode:
      _LOAD_FILAMENT_PRINTER_CHECK  ; Call the macro created to load filament dynamically
event_delay: 0.5
pause_delay: 0.5


[filament_switch_sensor RUNOUT_T2]
pause_on_runout: False
switch_pin: PC0
runout_gcode:
       _FILAMENT_RUNOUT  ; Call the macro created to handle runout behavior
runout_gcode:
       _LOAD_FILAMENT_PRINTER_CHECK  ;  Call the macro created to load filament dynamically
event_delay: 0.5
pause_delay: 0.5


#####################################################################
# 	Macros for when the filament runs out
#####################################################################
[gcode_macro _FILAMENT_RUNOUT]
gcode:
     ;RESPOND MSG="Running _FILAMENT_RUNOUT Macro"   ; Use this for troubleshooting

     {% if printer.save_variables.variables.started_printing == True %}
         UPDATE_DELAYED_GCODE ID=_FILAMENT_RUNOUT_SCHEDULED DURATION=15
     {% endif %}
     

     ;RESPOND MSG="‚è≥ Scheduled _FILAMENT_RUNOUT_SCHEDULED macro to run in 15 seconds..."   ; Use this for troubleshooting


[delayed_gcode _FILAMENT_RUNOUT_SCHEDULED]
gcode:
    ;RESPOND MSG="‚úÖ Running _FILAMENT_RUNOUT_SCHEDULED macro!"  ; Use this for troubleshooting

    _TRACK_TARGET_FILAMENT_RUNOUT

    ;RESPOND MSG="Finished Running _FILAMENT_RUNOUT_SCHEDULED Macro"   ; Use this for troubleshooting
   

[gcode_macro _TRACK_TARGET_FILAMENT_RUNOUT]
;variable_target_filament_runout: 0
description: Tracks target filament runout
gcode:
     ;RESPOND MSG="Running _TRACK_TARGET_FILAMENT_RUNOUT Macro"   ; Use this for troubleshooting

     SAVE_VARIABLE VARIABLE=target_filament_runout VALUE=800
     _TRACK_STARTING_FILAMENT_POSITION

     
[gcode_macro _TRACK_STARTING_FILAMENT_POSITION]
;variable_start_filament_position: 0
description:  Sets up and stores starting filament position
gcode:
     ;RESPOND MSG="Running _TRACK_STARTING_FILAMENT_POSITION Macro"   ; Use this for troubleshooting

     {% if printer.save_variables.variables.start_filament_position == 0 %}
        SAVE_VARIABLE VARIABLE=start_filament_position VALUE={printer.toolhead.position.e}
     {% endif %}

     _TRACK_DYNAMIC_FILAMENT_POSITION
    

[gcode_macro _TRACK_DYNAMIC_FILAMENT_POSITION]
;variable_dynamic_filament_position: 0
description: Updates filament position for runout sensors
gcode:
     ;RESPOND MSG="Running _TRACK_DYNAMIC_FILAMENT_POSITION Macro"  ; Use this for troubleshooting

     SAVE_VARIABLE VARIABLE=dynamic_filament_position VALUE={printer.toolhead.position.e}
     _TRACK_CURRENT_EXTRUDER

[gcode_macro _TRACK_CURRENT_EXTRUDER]
;variable_current_filament_extruder: '"null"'
;variable_original_filament_extruder: '"null"'
description: Updates which filament extruder is being called
gcode: 
     ;RESPOND MSG="Running _TRACK_CURRENT_EXTRUDER Macro"  ; Use this for troubleshooting
     
     {% if printer['extruder_stepper ex1'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 1 ü•á" %}
        {% set runout_sensor = "üö® RUNOUT_T0 üö®" %}
        {% set real_name = "extruder_stepper ex1" %}
    {% endif %}

    {% if printer['extruder_stepper ex2'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 2 ü•á" %}  
        {% set runout_sensor = "üö® RUNOUT_T1 üö®" %}
        {% set real_name = "extruder_stepper ex2" %}
    {% endif %}

    {% if printer['extruder_stepper ex3'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 3 ü•á" %}
       {% set runout_sensor = "üö® RUNOUT_T2 üö®" %}
        {% set real_name = "extruder_stepper ex3" %}
    {% endif %}

    {% if printer['extruder_stepper ex4'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 4 ü•á" %}  
        {% set runout_sensor = "üö® RUNOUT_T3 üö®" %}
        {% set real_name = "extruder_stepper ex4" %}
    {% endif %}

    {% if printer['extruder_stepper ex5'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 5 ü•á" %}
        {% set runout_sensor = "üö® RUNOUT_T4 üö®" %}
        {% set real_name = "extruder_stepper ex5" %}
    {% endif %}

    {% if printer['extruder_stepper ex6'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 6 ü•á" %}  
        {% set runout_sensor = "üö® RUNOUT_T5 üö®" %}
        {% set real_name = "extruder_stepper ex6" %}
    {% endif %}

    {% if printer['extruder_stepper ex7'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 7 ü•á" %}
        {% set runout_sensor = "üö® RUNOUT_T6 üö®" %}
        {% set real_name = "extruder_stepper ex7" %}
    {% endif %}

    {% if printer['extruder_stepper ex8'].motion_queue == 'extruder' %}
        {% set extruder_name = "ü•á Extruder - 8 ü•á" %}  
        {% set runout_sensor = "üö® RUNOUT_T7 üö®" %}
        {% set real_name = "extruder_stepper ex8" %}
    {% endif %}

    {% if printer.save_variables.variables.current_filament_extruder == 'null' %}
        RESPOND MSG="‚ö†Ô∏è Runout sensor '{runout_sensor}' detected during STL print on '{extruder_name}' ‚ö†Ô∏è"
        RESPOND MSG="üöÄ Tracking extrusion üöÄ"
        SAVE_VARIABLE VARIABLE=original_filament_extruder VALUE="'{real_name}'"
    {% endif %}
   
    SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE="'{real_name}'"
    _TRACK_EXTRUDER_CHANGE_VARIABLE

    
[gcode_macro _TRACK_EXTRUDER_CHANGE_VARIABLE]
;variable_extruder_change_during_runout: False
description: Sets the variable to let the program know that the filament is changing
gcode:
    ;RESPOND MSG="Running _TRACK_EXTRUDER_CHANGE_VARIABLE Macro"   ; Use this for troubleshooting

    {% if printer.save_variables.variables.current_filament_extruder != printer.save_variables.variables.original_filament_extruder %}
        SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=True
    {% endif %}
    
    _TRACK_EXTRUDER_CHANGE
     

[gcode_macro _TRACK_EXTRUDER_CHANGE]
description: Tracks if the extruder is going to change before filament finishes extruding
gcode:
    {% if printer.save_variables.variables.extruder_change_during_runout == True %}
        RESPOND MSG="üö´ Extruder switch requested before filament extrusion completed üö´"
        RESPOND MSG="‚õî Pausing Printer ‚õî"
        PAUSE
        M400  ; ensure all movements are completed before proceeding
        RESPOND MSG="‚úÇÔ∏è Filament now being cut and retracted to 120mm ‚úÇÔ∏è"
        {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex1" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex2" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex3" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex4" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=extruder
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex5" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex6" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex7" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex8" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=extruder
       {% endif %}
       
        SET_FILAMENT
        RESPOND MSG="‚úÖ Filament cut and retracted to 120mm ‚úÖ"
        RESPOND MSG="üîÑ Ready for new filament insertion üîÑ"
            
        SAVE_VARIABLE VARIABLE=printer_paused VALUE=True   ; let's the runout sensor know that it can auto-load filament
        

        ;RESPOND MSG="Running _TRACK_EXTRUDER_CHANGE Macro - EXTRUDER CHANGE DETECTED"   ;  Use this for troubleshooting

        UPDATE_DELAYED_GCODE ID=_FILAMENT_RUNOUT_SCHEDULED DURATION=0

      {% else %}
        ;RESPOND MSG="Running _TRACK_EXTRUDER_CHANGE Macro - NO EXTRUDER CHANGE DETECTED"  ; Use this for troubleshooting

        _TRACK_FILAMENT_USED
      {% endif %}

        
[gcode_macro _TRACK_FILAMENT_USED]
;variable_filament_used: 0
description: Tracks filament used based on stored position
gcode:
     ;RESPOND MSG="Running _TRACK_FILAMENT_USED"  ;  Used for troubleshooting

     SAVE_VARIABLE VARIABLE=filament_used VALUE={printer.save_variables.variables.dynamic_filament_position - printer.save_variables.variables.start_filament_position}
     _TRACK_FILAMENT_REMAINING

     
[gcode_macro _TRACK_FILAMENT_REMAINING]
;variable_filament_remaining: 0
description: Tracks filament remaining based on stored position
gcode:
     ;RESPOND MSG="Running _TRACK_FILAMENT_REMAINING"   ;  Used for troubleshooting

     SAVE_VARIABLE VARIABLE=filament_remaining VALUE={printer.save_variables.variables.target_filament_runout - printer.save_variables.variables.filament_used}
     _RESPOND_MESSAGE_FILAMENT_RUNOUT

     
[gcode_macro _RESPOND_MESSAGE_FILAMENT_RUNOUT]
description: Evaluates if the printer has extruded target filament
gcode:
    {% set filament_used = printer.save_variables.variables.filament_used|int %}
    {% set target_filament_runout = printer.save_variables.variables.target_filament_runout|int %}
    
     {% if filament_used >= target_filament_runout %}
           RESPOND MSG="‚úÖ {target_filament_runout}mm of filament extruded ‚úÖ"
           RESPOND MSG="‚èπÔ∏è Pausing Printer ‚èπÔ∏è"
           PAUSE
           M400  ; ensure all movements are completed before proceeding
           RESPOND MSG="‚úÇÔ∏è Filament now being cut and retracted to 120mm ‚úÇÔ∏è"
           SET_FILAMENT
           RESPOND MSG="‚ú® Filament cut and retracted to 120mm ‚ú®"
           RESPOND MSG="üéâ Ready for new filament insertion üéâ"
  
          SAVE_VARIABLE VARIABLE=printer_paused VALUE=True   ; let's the runout sensor know that it can auto-load filament
          
          ;RESPOND MSG="Running _RESPOND_MESSAGE_FILAMENT_RUNOUT Macro - TARGET FILAMENT AMOUNT REACHED"  ;  Used for troubleshooting

           UPDATE_DELAYED_GCODE ID=_FILAMENT_RUNOUT_SCHEDULED DURATION=0
     {% else %}
           _RESPOND_MESSAGE_FILAMENT_USED
     {% endif %}
  

[gcode_macro _RESPOND_MESSAGE_FILAMENT_USED]
description: Evaluates how much filament has been extruded
gcode:
     {% set filament_used = printer.save_variables.variables.filament_used|int %}
     {% if filament_used > 0  %}
           ;RESPOND MSG="Running _RESPOND_MESSAGE_FILAMENT_USED Macro - FILAMENT USED > 0"   ;  Used for troubleshooting
           _RESPOND_MESSAGE_FILAMENT

     {% else %}
           ;RESPOND MSG="Running _RESPOND_MESSAGE_FILAMENT_USED Macro - FILAMENT USED < 0"  ;  Used for troubleshooting

           _FILAMENT_RUNOUT
     {% endif %}  

[gcode_macro _RESPOND_MESSAGE_FILAMENT]
description: Gives a visual status of how much filament has been extruded
gcode: 
    ;RESPOND MSG="Running _RESPOND_MESSAGE_FILAMENT Macro - GIVING FILAMENT STATUS"  ;  Used for troubleshooting

    {% set filament_used = printer.save_variables.variables.filament_used|int %}
    {% set filament_remaining = printer.save_variables.variables.filament_remaining|int %}
    {% set target_filament_runout = printer.save_variables.variables.target_filament_runout|int %}
    
    RESPOND MSG="üîÑ {filament_used}mm extruded üîÑ - ‚è≥ {filament_remaining}mm remaining to target ({target_filament_runout}mm) ‚è≥"
    _FILAMENT_RUNOUT

#####################################################################
# 	Macro for when the filament is inserted
#####################################################################
[gcode_macro _LOAD_FILAMENT_PRINTER_CHECK]
description: Check to make sure printer is running before engaging macro
gcode:
         {% if printer.save_variables.variables.printer_paused == True %}
             _LOAD_FILAMENT_AFTER_RUNOUT
         {% endif %}
         
[gcode_macro _LOAD_FILAMENT_AFTER_RUNOUT]
description:  Load filament macros
gcode:
        {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex1" %}
            {% set extruder_name = "ü•á Extruder - 1 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T0 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex2" %}
            {% set extruder_name = "ü•á Extruder - 2 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T1 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex3" %}
            {% set extruder_name = "ü•á Extruder - 3 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T2 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex4" %}
            {% set extruder_name = "ü•á Extruder - 4 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T3 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=extruder
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex5" %}
            {% set extruder_name = "ü•á Extruder - 5 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T4 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex6" %}
            {% set extruder_name = "ü•á Extruder - 6 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T5 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex7" %}
            {% set extruder_name = "ü•á Extruder - 7 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T6 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex8" %}
            {% set extruder_name = "ü•á Extruder - 8 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T7 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=extruder
       {% endif %}

       ;{% if "xyz" not in printer.toolhead.homed_axes %}
       ;  G28
       ;{% endif %}
       
       ; Countown before activating the extruder to load filament
       {% set timer_countdown = 30 %}
       RESPOND MSG="üéâ Filament detected for Runout sensor '{runout_sensor}' on '{extruder_name}' üéâ"
        
       {% for filament_loading_countdown in range(timer_countdown, 0, -1) %}
            G4 P2000  ; Wait for 2 seconds
            M118 "üïí Preparing to load filament in '{filament_loading_countdown}' seconds üïí"  ;  Message countdown
       {% endfor %}

       RESPOND MSG="‚ôªÔ∏è Countdown complete! ‚ôªÔ∏è"  ;  confirmation message

       
       ;  activating extruder and loading filament
       {% set target_temp = printer.save_variables.variables.extruder_temperature %}
        M104 S{target_temp - 50}    ; Preheat nozzle slightly
       
       RESPOND MSG="üéØ Now loading filament for {extruder_name} üéØ"

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 300mm of filament loaded üîÑ - ‚è≥ 750mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 600mm of filament loaded üîÑ - ‚è≥ 450mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 900mm of filament loaded üîÑ - ‚è≥ 150mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       RESPOND MSG="‚úã Wait while the extruder is brought up to working temperature ('{printer.save_variables.variables.extruder_temperature}') ‚úã"      ; respond message
       M109 S{target_temp}         ; Wait for nozzle to heat-up to final temp  (added by MS CoPilot)
       
       G92 E0        ;  resets extruder position
       G1 E150 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 1050mm of filament loaded üîÑ - ‚è≥ 0mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       ;RESPOND MSG="‚ò¢Ô∏è Moving Z-axis to a safe place above the work area ‚ò¢Ô∏è"
       ;G90            ; switch to absolute position
       ;G1 Z350 F1800  ; move Z axis to 350mm above plate
       M400           ; wait for all movement commands to finish before proceeding
       RESPOND MSG="‚úîÔ∏è Filament loaded successfully into {extruder_name}‚úîÔ∏è"

      ;  checking if an extruder switch was commanded
      {% if printer.save_variables.variables.extruder_change_during_runout == True %}
            _LOAD_FILAMENT_EXTRUDER_SWITCH

      {% else %}
            RESPOND MSG="üëç No extruder switch detected üëç"   ; confirmation message
            RESPOND MSG="üöÄ {extruder_name} is ready to print üöÄ"   ;  confirmation message
            RESPOND MSG="üßº Make sure the printer nozzle is clean üßº"    ; confirmation message
            RESPOND MSG="üéà Tap the continue button to re-start where you left off before the filament ran out üéà"  ;  confirmation message
            
            SAVE_VARIABLE VARIABLE=printer_paused VALUE=False   ; let's the runout sensor know that it cannot auto-load filament
            SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
            SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
            SAVE_VARIABLE VARIABLE=target_filament_runout VALUE=0
            SAVE_VARIABLE VARIABLE=start_filament_position VALUE=0
            SAVE_VARIABLE VARIABLE=dynamic_filament_position VALUE=0
            SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;Used in filament loading macros
            SAVE_VARIABLE VARIABLE=filament_used VALUE=0
            SAVE_VARIABLE VARIABLE=filament_remaining VALUE=0
      {% endif %}

[gcode_macro _LOAD_FILAMENT_EXTRUDER_SWITCH]
description: changes the current extruder that was switched
gcode: 
       RESPOND MSG="ü™∑ Extruder switch requested before filament extrusion completed ü™∑"
       RESPOND MSG="üî™ Filament now being cut and retracted to 120mm üî™"
       SET_FILAMENT
       RESPOND MSG="üéÜ Filament cut and retracted to 120mm üéÜ"

       ;  setting to the changed filament extruder
       {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex1" %}
            {% set changed_extruder_name = "ü•á Extruder - 1 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T0 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex2" %}
            {% set changed_extruder_name = "ü•á Extruder - 2 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T1 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex3" %}
            {% set changed_extruder_name = "ü•á Extruder - 3 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T2 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex4" %}
            {% set changed_extruder_name = "ü•á Extruder - 4 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T3 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=extruder
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex5" %}
            {% set changed_extruder_name = "ü•á Extruder - 5 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T4 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex6" %}
            {% set changed_extruder_name = "ü•á Extruder - 6 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T5 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex7" %}
            {% set changed_extruder_name = "ü•á Extruder - 7 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T6 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex8" %}
            {% set changed_extruder_name = "ü•á Extruder - 8 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T7 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=extruder
        {% endif %}

        RESPOND MSG="üî∞ Switched back to Runout sensor '{changed_runout_sensor}' on '{changed_extruder_name}' üî∞"   ; confirmation message
        RESPOND MSG="‚ò£Ô∏è Extruding filament for Runout sensor '{changed_runout_sensor}' on '{changed_extruder_name}' ‚ò£Ô∏è"  ;  confirmation message
        G92 E0        ;  resets extruder position
        G1 E120 F300              ; get filament positioned to print
        M400  ; Ensure all movements are completed before proceeding
        RESPOND MSG="üòã '{changed_extruder_name}' is now ready to print üòã"  ;  confirmation message
        RESPOND MSG="üßº Make sure the printer nozzle is clean üßº"    ; confirmation message
        RESPOND MSG="üéà Tap the continue button to re-start where you left off before the filament ran out üéà"  ;  confirmation message

         SAVE_VARIABLE VARIABLE=printer_paused VALUE=False   ; let's the runout sensor know that it cannot auto-load filament
         SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
         SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
         SAVE_VARIABLE VARIABLE=target_filament_runout VALUE=0
         SAVE_VARIABLE VARIABLE=start_filament_position VALUE=0
         SAVE_VARIABLE VARIABLE=dynamic_filament_position VALUE=0
         SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;Used in filament loading macros
         SAVE_VARIABLE VARIABLE=filament_used VALUE=0
         SAVE_VARIABLE VARIABLE=filament_remaining VALUE=0
        
