[gcode_macro _LOAD_FILAMENT_PRINTER_CHECK]
description: Check to make sure printer is running before engaging macro
gcode:
             _LOAD_FILAMENT_AFTER_RUNOUT
         
[gcode_macro _LOAD_FILAMENT_AFTER_RUNOUT]
description:  Load filament macros
gcode:
        {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex1" %}
            {% set extruder_name = "ü•á Extruder - 1 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T0 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex2" %}
            {% set extruder_name = "ü•á Extruder - 2 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T1 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex3" %}
            {% set extruder_name = "ü•á Extruder - 3 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T2 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex4" %}
            {% set extruder_name = "ü•á Extruder - 4 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T3 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=extruder
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex5" %}
            {% set extruder_name = "ü•á Extruder - 5 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T4 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex6" %}
            {% set extruder_name = "ü•á Extruder - 6 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T5 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex7" %}
            {% set extruder_name = "ü•á Extruder - 7 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T6 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

       {% if printer.save_variables.variables.original_filament_extruder == "extruder_stepper ex8" %}
            {% set extruder_name = "ü•á Extruder - 8 ü•á" %}
            {% set runout_sensor = "üö® RUNOUT_T7 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=extruder
       {% endif %}

       ; Countown before activating the extruder to load filament
       {% set timer_countdown = 30 %}
       RESPOND MSG="üéâ Filament detected for Runout sensor '{runout_sensor}' on '{extruder_name}' üéâ"
        
       {% for filament_loading_countdown in range(timer_countdown, 0, -1) %}
            G4 P2000  ; Wait for 2 seconds
            M118 "üïí Preparing to load filament in '{filament_loading_countdown}' seconds üïí"  ;  Message countdown
       {% endfor %}

       RESPOND MSG="‚ôªÔ∏è Countdown complete! ‚ôªÔ∏è"  ;  confirmation message

       ; moving printer head to dispense filament
       RESPOND MSG="‚ò¢Ô∏è Homing X-axis to load filament for {extruder_name} ‚ò¢Ô∏è"
       G90 ; Switch to absolute positioning
       G28 X  ; Move X-axis to the home position
       M400  ; Wait for all movement commands to finish before proceeding
       RESPOND MSG="üèÅ X-axis is now at Home position üèÅ"  ;  confirmation message
       
       ;  activating extruder and loading filament
       RESPOND MSG="üéØ Now loading filament for {extruder_name} üéØ"

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 300mm of filament loaded üîÑ - ‚è≥ 750mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 600mm of filament loaded üîÑ - ‚è≥ 450mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 900mm of filament loaded üîÑ - ‚è≥ 150mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       G92 E0        ;  resets extruder position
       G1 E300 F300  ;  load filament 300mm at 300mm/min
       M400          ;  ensures all movements are completed before proceeding
       RESPOND MSG="üîÑ 1050mm of filament loaded üîÑ - ‚è≥ 0mm remaining to target (1050mm) ‚è≥"   ;  gives a tally of filament loaded

       RESPOND MSG="‚úîÔ∏è Filament loaded successfully into {extruder_name}‚úîÔ∏è"

      ;  checking if an extruder switch was commanded
      {% if printer.save_variables.variables.extruder_change_during_runout == True %}
            _LOAD_FILAMENT_EXTRUDER_SWITCH

            SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
            SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
            SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;   Reset variables
      {% else %}
            RESPOND MSG="üëç No extruder switch detected üëç"   ; confirmation message
            RESPOND MSG="üöÄ {extruder_name} is ready to print üöÄ"   ;  confirmation message
            RESPOND MSG="üßº Make sure the printer nozzle is clean üßº"    ; confirmation message
            RESPOND MSG="üéà Tap the continue button to re-start where you left off before the filament ran out üéà"  ;  confirmation message
            
            SAVE_VARIABLE VARIABLE=original_filament_extruder value='"null"'  ;   Reset variables
            SAVE_VARIABLE VARIABLE=current_filament_extruder VALUE='"null"'   ;   Reset variables
            SAVE_VARIABLE VARIABLE=extruder_change_during_runout VALUE=False  ;   Reset variables
      {% endif %}

            
[gcode_macro _LOAD_FILAMENT_EXTRUDER_SWITCH]
description: changes the current extruder that was switched
gcode: 
       RESPOND MSG="ü™∑ Extruder switch requested before filament extrusion completed ü™∑"
       RESPOND MSG="üî™ Filament now being cut and retracted to 100mm üî™"
       SET_FILAMENT
       RESPOND MSG="üéÜ Filament cut and retracted to 100mm üéÜ"

       ;  setting to the changed filament extruder
       {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex1" %}
            {% set changed_extruder_name = "ü•á Extruder - 1 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T0 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex2" %}
            {% set changed_extruder_name = "ü•á Extruder - 2 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T1 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex3" %}
            {% set changed_extruder_name = "ü•á Extruder - 3 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T2 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex4" %}
            {% set changed_extruder_name = "ü•á Extruder - 4 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T3 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=extruder
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex5" %}
            {% set changed_extruder_name = "ü•á Extruder - 5 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T4 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex6" %}
            {% set changed_extruder_name = "ü•á Extruder - 6 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T5 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex7" %}
            {% set changed_extruder_name = "ü•á Extruder - 7 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T6 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=extruder
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=
        {% endif %}

        {% if printer.save_variables.variables.current_filament_extruder == "extruder_stepper ex8" %}
            {% set changed_extruder_name = "ü•á Extruder - 8 ü•á" %}
            {% set changed_runout_sensor = "üö® RUNOUT_T7 üö®" %}
            SYNC_EXTRUDER_MOTION EXTRUDER=ex1 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex2 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex3 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex4 MOTION_QUEUE=
	        ;  When ecm1 is active, uncomment the lines ex5, ex6, ex7, ex8
            SYNC_EXTRUDER_MOTION EXTRUDER=ex5 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex6 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex7 MOTION_QUEUE=
            SYNC_EXTRUDER_MOTION EXTRUDER=ex8 MOTION_QUEUE=extruder
        {% endif %}

        RESPOND MSG="üî∞ Switched back to Runout sensor '{changed_runout_sensor}' on '{changed_extruder_name}' üî∞"   ; confirmation message
        RESPOND MSG="‚ò£Ô∏è Extruding filament for Runout sensor '{changed_runout_sensor}' on '{changed_extruder_name}' ‚ò£Ô∏è"  ;  confirmation message
        G92 E0        ;  resets extruder position
        G1 E100 F300              ; get filament positioned to print
        M400  ; Ensure all movements are completed before proceeding
        RESPOND MSG="üòã '{changed_extruder_name}' is now ready to print üòã"  ;  confirmation message
        RESPOND MSG="üßº Make sure the printer nozzle is clean üßº"    ; confirmation message
        RESPOND MSG="üéà Tap the continue button to re-start where you left off before the filament ran out üéà"  ;  confirmation message
        
